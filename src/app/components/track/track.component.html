<div class="track-container">
  @if (totalDurationMs() > 0 && sessionInfo().dateStart) {
  <!-- Visualizzazione disponibile solo quando la sessione Ã¨ valida -->
  @if (locations().length > 0) {
  <mat-card class="track-visualization">
    <mat-card-content>
      <!-- Layout con classifica e tracciato -->
      <div class="track-layout">
        <!-- Classifica piloti a sinistra -->
        @if (driverStandings().length > 0) {
        <div class="standings-sidebar">
          <div class="standings-list">
            @for (standing of driverStandings(); track standing.driver.driverNumber) {
            <div class="standing-item">
              <div class="standing-position">{{ standing.position }}</div>
              <div
                class="standing-color"
                [style.background-color]="'#' + standing.driver.teamColour"
              ></div>
              <div class="standing-driver-info">
                <div class="standing-driver-name">{{ standing.driver.nameAcronym }}</div>
                <!--div class="standing-team-name">{{ standing.driver.teamName }}</div-->
              </div>
              <div class="standing-number">{{ standing.driver.driverNumber }}</div>
            </div>
            }
          </div>
        </div>
        }

        <!-- SVG Track Visualization -->
        <div class="track-svg-container">
          <svg class="track-svg" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet">
            <!-- Track path (background) -->
            <path class="track-path" [attr.d]="trackPath()" />

            <!-- Driver markers -->
            @for (driverLoc of currentDriverLocations(); track driverLoc.driver.driverNumber) {
            <g
              class="driver-marker"
              [attr.transform]="
                'translate(' + scaleX(driverLoc.location.x) + ',' + scaleY(driverLoc.location.y) + ')'
              "
            >
              <circle [attr.r]="12" [attr.fill]="'#' + driverLoc.driver.teamColour" />
              <text class="driver-number" y="1">
                {{ driverLoc.driver.driverNumber }}
              </text>
              <title>{{ driverLoc.driver.nameAcronym }} - {{ driverLoc.driver.teamName }}</title>
            </g>
            }
          </svg>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Controls -->
  <mat-card class="controls-container">
    <!-- Chunk Info -->
    <div class="chunk-info">
      <span>{{ formatDuration(currentTimeMs()) }} / {{ formatDuration(totalDurationMs()) }}</span>
    </div>

    <!-- Slider -->
    <div class="slider-container">
      <div class="flex gap-2">
        <label class="slider-label"> Timeline Control </label>
        @if (isLoadingData()) {
        <span class="loading-indicator">
          <mat-icon>sync</mat-icon>
          Loading...
        </span>
        }
      </div>

      <mat-slider
        [min]="0"
        [max]="totalDurationMs()"
        [step]="1000"
        [discrete]="true"
        [showTickMarks]="false"
      >
        <input
          title="slider-position"
          matSliderThumb
          [value]="currentTimeMs()"
          (valueChange)="onSliderChange($event)"
          [attr.aria-label]="'Timeline position'"
        />
      </mat-slider>
    </div>

    <!-- Playback Controls -->
    <div class="playback-controls">
      <button mat-raised-button color="primary" (click)="togglePlayPause()">
        <mat-icon>{{ isPlaying() ? 'pause' : 'play_arrow' }}</mat-icon>
        {{ isPlaying() ? 'Pause' : 'Play' }}
      </button>
      <button mat-raised-button (click)="reset()">
        <mat-icon>replay</mat-icon>
        Reset
      </button>
    </div>
  </mat-card>
  } @else {
  <mat-card class="no-data-message">
    <mat-card-content>
      <p>Loading track data...</p>
      <p>Loaded {{ loadedChunks.size }} / {{ totalChunks() }} chunks</p>
    </mat-card-content>
  </mat-card>
  } } @else {
  <div class="no-data-message">
    <p>No session data available</p>
  </div>
  }
</div>
